<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Kepuh Statistic</title>
	<link rel="stylesheet" href="/stylesheets/style.css" />
	<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
		integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-50">
	<div class="container mx-auto p-4 md:p-6">
		<!-- Notification Container -->
		<div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2 max-w-sm"></div>

		<h1 class="text-2xl md:text-3xl font-bold mb-6 text-gray-800">Dashboard Desa Kepuh</h1>
		<div class="flex flex-col lg:flex-row gap-6">
			<div class="w-full lg:w-1/4 space-y-6">
				<h3 class="font-bold text-xl text-gray-800">Total Pengeluaran Air</h3>
				<div>
					<label for="kategori" class="block text-gray-700 font-medium mb-1">Pilih Kategori:</label>
					<select id="kategori" class="w-full border border-gray-300 rounded-lg p-2 text-gray-700">
						<option value="perhari">Perhari</option>
						<option value="perminggu" selected>Perminggu</option>
						<option value="perbulan">Perbulan</option>
					</select>
				</div>
				<div
					class="bg-white rounded-lg shadow-md border border-slate-200 flex flex-col sm:flex-row justify-between overflow-hidden">
					<div class="p-6">
						<h2 class="text-xl font-semibold text-gray-700">Masjid 1</h2>
						<p id="masjid1-value" class="text-2xl font-bold text-blue-600">1,341 Liter</p>
						<p id="masjid1-growth" class="text-sm text-gray-500">+10% dari minggu lalu</p>
					</div>
					<div
						class="bg-blue-600 flex justify-center items-center p-4 sm:px-8 rounded-l-none sm:rounded-l-3xl flex-col">
						<img src="./images/mesjid.svg" alt="Ikon Masjid" />
						<h1 class="font-semibold text-md mt-2 text-white">Masjid 1</h1>
					</div>
				</div>
				<div
					class="bg-white rounded-lg shadow-md border border-slate-200 flex flex-col sm:flex-row justify-between overflow-hidden">
					<div class="p-6">
						<h2 class="text-xl font-semibold text-gray-700">Masjid 2</h2>
						<p id="masjid2-value" class="text-2xl font-bold text-red-500">980 Liter</p>
						<p id="masjid2-growth" class="text-sm text-gray-500">+8% dari minggu lalu</p>
					</div>
					<div
						class="bg-red-500 flex justify-center items-center p-4 sm:px-8 rounded-l-none sm:rounded-l-3xl flex-col">
						<img src="./images/mesjid.svg" alt="Ikon Masjid" />
						<h1 class="font-semibold text-md mt-2 text-white">Masjid 2</h1>
					</div>
				</div>
				<div
					class="bg-white rounded-lg shadow-md border border-slate-200 flex flex-col sm:flex-row justify-between overflow-hidden">
					<div class="p-6">
						<h2 class="text-xl font-semibold text-gray-700">Masjid 3</h2>
						<p id="masjid3-value" class="text-2xl font-bold text-green-600">1,100 Liter</p>
						<p id="masjid3-growth" class="text-sm text-gray-500">+12% dari minggu lalu</p>
					</div>
					<div
						class="bg-green-600 flex justify-center items-center p-4 sm:px-8 rounded-l-none sm:rounded-l-3xl flex-col">
						<img src="./images/mesjid.svg" alt="Ikon Masjid" />
						<h1 class="font-semibold text-md mt-2 text-white">Masjid 3</h1>
					</div>
				</div>
			</div>
			<div class="w-full lg:w-3/4">
				<div class="bg-white p-4 md:p-6 rounded-lg shadow-md">
					<div class="flex items-center w-full gap-4 text-sm sm:text-base px-2 sm:px-10 mb-4">
						<div id="tab-map"
							class="w-1/4 text-center text-black cursor-pointer border-b-4 border-blue-600 pb-2">
							<p>Map</p>
						</div>
						<div id="tab-flow"
							class="w-1/4 text-center text-gray-600 cursor-pointer border-b-4 border-transparent pb-2">
							<p>Flow Rate</p>
						</div>
						<div id="tab-rssi"
							class="w-1/4 text-center text-gray-600 cursor-pointer border-b-4 border-transparent pb-2">
							<p>RSSI</p>
						</div>
						<div id="tab-kontrol"
							class="w-1/4 text-center text-gray-600 cursor-pointer border-b-4 border-transparent pb-2">
							<p>Kontrol Pompa</p>
						</div>
					</div>

					<div id="content-map" class="h-[400px] md:h-[500px] rounded-xl" style="display: block;">
						<div id="leafletMap" class="w-full h-full rounded-xl"></div>
					</div>
					<div id="content-flow" style="display: none;" class="h-[400px] md:h-auto md:aspect-video">
						<canvas id="flowrate"></canvas>
					</div>
					<div id="content-rssi" style="display: none;" class="h-[400px] md:h-auto md:aspect-video">
						<canvas id="rssiChart"></canvas>
					</div>
					<div id="content-kontrol" style="display: none;" class="p-4">
						<h3 class="text-xl font-semibold mb-4 text-gray-800">Kontrol Pompa Air</h3>
						<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
							<!-- Masjid 1 -->
							<div
								class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hover:shadow-xl transition-shadow duration-300">
								<div class="flex items-center justify-between mb-4">
									<h4 class="font-bold text-xl text-blue-600">Masjid 1</h4>
									<div id="pump-indicator-1" class="relative">
										<div class="w-4 h-4 bg-gray-400 rounded-full animate-pulse"></div>
										<div
											class="absolute -top-1 -right-1 w-6 h-6 bg-gray-300 rounded-full opacity-30 animate-ping">
										</div>
									</div>
								</div>
								<div class="mb-4">
									<div class="flex items-center gap-2 mb-2">
										<span class="text-gray-600 text-sm">Status:</span>
										<span id="kontrol-status-1"
											class="font-bold text-gray-500 text-sm px-2 py-1 bg-gray-100 rounded-full">
											üîÑ Memuat...
										</span>
									</div>
									<div class="text-xs text-gray-500">
										Update terakhir: <span id="last-update-1">-</span>
									</div>
								</div>
								<div class="flex gap-3">
									<button id="btn-open-1" onclick="controlPipe('node1', 'OPEN')"
										class="flex-1 bg-green-500 hover:bg-green-600 disabled:bg-gray-400 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-2">
										<span>üö∞</span> Buka
									</button>
									<button id="btn-close-1" onclick="controlPipe('node1', 'CLOSE')"
										class="flex-1 bg-red-500 hover:bg-red-600 disabled:bg-gray-400 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-2">
										<span>üîí</span> Tutup
									</button>
								</div>
							</div>

							<!-- Masjid 2 -->
							<div
								class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hover:shadow-xl transition-shadow duration-300">
								<div class="flex items-center justify-between mb-4">
									<h4 class="font-bold text-xl text-red-500">Masjid 2</h4>
									<div id="pump-indicator-2" class="relative">
										<div class="w-4 h-4 bg-gray-400 rounded-full animate-pulse"></div>
										<div
											class="absolute -top-1 -right-1 w-6 h-6 bg-gray-300 rounded-full opacity-30 animate-ping">
										</div>
									</div>
								</div>
								<div class="mb-4">
									<div class="flex items-center gap-2 mb-2">
										<span class="text-gray-600 text-sm">Status:</span>
										<span id="kontrol-status-2"
											class="font-bold text-gray-500 text-sm px-2 py-1 bg-gray-100 rounded-full">
											üîÑ Memuat...
										</span>
									</div>
									<div class="text-xs text-gray-500">
										Update terakhir: <span id="last-update-2">-</span>
									</div>
								</div>
								<div class="flex gap-3">
									<button id="btn-open-2" onclick="controlPipe('node2', 'OPEN')"
										class="flex-1 bg-green-500 hover:bg-green-600 disabled:bg-gray-400 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-2">
										<span>üö∞</span> Buka
									</button>
									<button id="btn-close-2" onclick="controlPipe('node2', 'CLOSE')"
										class="flex-1 bg-red-500 hover:bg-red-600 disabled:bg-gray-400 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-2">
										<span>üîí</span> Tutup
									</button>
								</div>
							</div>

							<!-- Masjid 3 -->
							<div
								class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hover:shadow-xl transition-shadow duration-300">
								<div class="flex items-center justify-between mb-4">
									<h4 class="font-bold text-xl text-green-600">Masjid 3</h4>
									<div id="pump-indicator-3" class="relative">
										<div class="w-4 h-4 bg-gray-400 rounded-full animate-pulse"></div>
										<div
											class="absolute -top-1 -right-1 w-6 h-6 bg-gray-300 rounded-full opacity-30 animate-ping">
										</div>
									</div>
								</div>
								<div class="mb-4">
									<div class="flex items-center gap-2 mb-2">
										<span class="text-gray-600 text-sm">Status:</span>
										<span id="kontrol-status-3"
											class="font-bold text-gray-500 text-sm px-2 py-1 bg-gray-100 rounded-full">
											üîÑ Memuat...
										</span>
									</div>
									<div class="text-xs text-gray-500">
										Update terakhir: <span id="last-update-3">-</span>
									</div>
								</div>
								<div class="flex gap-3">
									<button id="btn-open-3" onclick="controlPipe('node3', 'OPEN')"
										class="flex-1 bg-green-500 hover:bg-green-600 disabled:bg-gray-400 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-2">
										<span>üö∞</span> Buka
									</button>
									<button id="btn-close-3" onclick="controlPipe('node3', 'CLOSE')"
										class="flex-1 bg-red-500 hover:bg-red-600 disabled:bg-gray-400 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-2">
										<span>üîí</span> Tutup
									</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.min.js"></script>
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
	<script src="/socket.io/socket.io.js"></script>

	<script>
		// --- Chart Rendering ---
		let flowrateChart, rssiChart;

		// Function to create flowrate chart
		function createFlowrateChart(data) {
			console.log('üèóÔ∏è  Creating flowrate chart with data:', data);
			const canvas = document.getElementById('flowrate');
			if (!canvas) {
				console.error('‚ùå Flowrate canvas element not found!');
				return;
			}

			const ctx = canvas.getContext('2d');
			if (flowrateChart) flowrateChart.destroy();

			flowrateChart = new Chart(ctx, {
				type: "line",
				data: data,
				options: {
					responsive: true,
					maintainAspectRatio: false,
					animation: {
						duration: 500, // Fast like flowing water
						easing: 'linear', // Constant flow motion
						animateRotate: false,
						animateScale: false,
						// Smooth continuous flow animation
						onProgress: function (animation) {
							// Create flowing water effect with subtle glow
							const ctx = animation.chart.ctx;
							ctx.shadowColor = 'rgba(54, 162, 235, 0.2)';
							ctx.shadowBlur = 2;
						},
						onComplete: function (animation) {
							console.log('Flowrate chart flow animation completed');
						}
					},
					transitions: {
						active: {
							animation: {
								duration: 500,
								easing: 'linear' // Linear for consistent water flow
							}
						}
					},
					elements: {
						line: {
							tension: 0.4, // More fluid curves like flowing water
							borderWidth: 3, // Thicker line for better flow visibility
							fill: false,
							borderCapStyle: 'round', // Smooth line endings
							borderJoinStyle: 'round', // Smooth connections
							stepped: false // Smooth continuous line
						},
						point: {
							radius: 1, // Smaller points for cleaner water flow
							hoverRadius: 4,
							borderWidth: 0, // No border for smoother look
							pointBackgroundColor: function (context) {
								return context.dataset.borderColor;
							},
							pointHoverBackgroundColor: function (context) {
								return context.dataset.borderColor;
							}
						}
					},
					scales: {
						x: {
							title: { display: true, text: "Waktu" },
							ticks: {
								maxTicksLimit: 10 // Limit number of labels shown
							}
						},
						y: { title: { display: true, text: "Flow Rate (L/min)" } }
					}
				}
			});
			console.log('‚úÖ Flowrate chart created successfully with flowing water animations');
		}

		// Function to create RSSI chart
		function createRssiChart(data) {
			console.log('üèóÔ∏è  Creating RSSI chart with data:', data);
			const canvas = document.getElementById('rssiChart');
			if (!canvas) {
				console.error('‚ùå RSSI canvas element not found!');
				return;
			}

			const ctx = canvas.getContext('2d');
			if (rssiChart) rssiChart.destroy();

			rssiChart = new Chart(ctx, {
				type: "line",
				data: data,
				options: {
					responsive: true,
					maintainAspectRatio: false,
					animation: {
						duration: 500, // Fast like flowing water
						easing: 'linear', // Constant flow motion
						animateRotate: false,
						animateScale: false,
						// Smooth continuous flow animation
						onProgress: function (animation) {
							// Create flowing water effect with subtle glow
							const ctx = animation.chart.ctx;
							ctx.shadowColor = 'rgba(255, 99, 132, 0.2)';
							ctx.shadowBlur = 2;
						},
						onComplete: function (animation) {
							console.log('RSSI chart flow animation completed');
						}
					},
					transitions: {
						active: {
							animation: {
								duration: 500,
								easing: 'linear' // Linear for consistent water flow
							}
						}
					},
					elements: {
						line: {
							tension: 0.4, // More fluid curves like flowing water
							borderWidth: 3, // Thicker line for better flow visibility
							fill: false,
							borderCapStyle: 'round', // Smooth line endings
							borderJoinStyle: 'round', // Smooth connections
							stepped: false // Smooth continuous line
						},
						point: {
							radius: 1, // Smaller points for cleaner water flow
							hoverRadius: 4,
							borderWidth: 0, // No border for smoother look
							pointBackgroundColor: function (context) {
								return context.dataset.borderColor;
							},
							pointHoverBackgroundColor: function (context) {
								return context.dataset.borderColor;
							}
						}
					},
					scales: {
						x: {
							title: { display: true, text: "Waktu" },
							ticks: {
								maxTicksLimit: 10 // Limit number of labels shown
							}
						},
						y: { title: { display: true, text: "RSSI (dBm)" } }
					}
				}
			});
			console.log('‚úÖ RSSI chart created successfully with flowing water animations');
		}

		// --- Static Data and UI Elements ---
		const data = {
			perhari: { masjid1: { value: 123, growth: "+2%" }, masjid2: { value: 110, growth: "+1%" }, masjid3: { value: 95, growth: "+3%" } },
			perminggu: { masjid1: { value: 1234, growth: "+10%" }, masjid2: { value: 980, growth: "+8%" }, masjid3: { value: 1100, growth: "+12%" } },
			perbulan: { masjid1: { value: 5120, growth: "+25%" }, masjid2: { value: 4890, growth: "+20%" }, masjid3: { value: 4500, growth: "+18%" } }
		};
		const kategoriSelect = document.getElementById("kategori");
		kategoriSelect.addEventListener("change", function () { /* ... logic ... */ });

		// --- Leaflet Map ---
		const map = L.map("leafletMap").setView([-6.9557, 108.1959], 17);
		L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", { attribution: "¬© OpenStreetMap" }).addTo(map);
		const blueIcon = new L.Icon({ iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png", shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png", iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
		const redIcon = new L.Icon({ iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png", shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png", iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
		const greenIcon = new L.Icon({ iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png", shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png", iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
		const locations = [{ lat: -6.955734150558402, lng: 108.19593162716883, name: "Masjid 1", icon: blueIcon }, { lat: -6.9545057618846755, lng: 108.19542334839034, name: "Masjid 2", icon: redIcon }, { lat: -6.9549011978738875, lng: 108.19604852304519, name: "Masjid 3", icon: greenIcon }];
		locations.forEach((lokasi) => L.marker([lokasi.lat, lokasi.lng], { icon: lokasi.icon }).addTo(map).bindPopup(lokasi.name));

		// --- Tab Switching Logic ---
		const tabs = {
			map: { btn: document.getElementById("tab-map"), content: document.getElementById("content-map") },
			flow: { btn: document.getElementById("tab-flow"), content: document.getElementById("content-flow") },
			rssi: { btn: document.getElementById("tab-rssi"), content: document.getElementById("content-rssi") },
			kontrol: { btn: document.getElementById("tab-kontrol"), content: document.getElementById("content-kontrol") },
		};

		function switchTab(activeTabKey) {
			Object.keys(tabs).forEach(key => {
				const isActive = key === activeTabKey;
				tabs[key].content.style.display = isActive ? "block" : "none";
				tabs[key].btn.classList.toggle("text-black", isActive);
				tabs[key].btn.classList.toggle("border-blue-600", isActive);
				tabs[key].btn.classList.toggle("text-gray-600", !isActive);
				tabs[key].btn.classList.toggle("border-transparent", !isActive);
			});

			if (activeTabKey === 'map') {
				setTimeout(() => map.invalidateSize(), 100);
			} else if (activeTabKey === 'flow') {
				// Always destroy existing chart and create a new one for reliable updates
				if (flowrateChart) {
					flowrateChart.destroy();
					flowrateChart = null;
				}

				// Use latest data if available, otherwise fetch from server
				if (window.latestFlowrateData) {
					createFlowrateChart(window.latestFlowrateData);
				} else {
					// Fetch fresh data for flowrate chart
					fetch("/flowrate")
						.then(response => response.json())
						.then(data => {
							createFlowrateChart(data);
						})
						.catch(error => {
							console.error("Error fetching flowrate data:", error);
						});
				}
			} else if (activeTabKey === 'rssi') {
				// Always destroy existing chart and create a new one for reliable updates
				if (rssiChart) {
					rssiChart.destroy();
					rssiChart = null;
				}

				// Use latest data if available, otherwise fetch from server
				if (window.latestRssiData) {
					createRssiChart(window.latestRssiData);
				} else {
					// Fetch fresh data for RSSI chart
					fetch("/rssi")
						.then(response => response.json())
						.then(data => {
							createRssiChart(data);
						})
						.catch(error => {
							console.error("Error fetching RSSI data:", error);
						});
				}
			}
		}

		Object.keys(tabs).forEach(key => tabs[key].btn.addEventListener("click", () => switchTab(key)));

		// --- Socket.io and Pump Control ---
		const socket = io();

		// Pump status tracking
		const pumpStatus = {
			node1: { status: 'unknown', lastUpdate: null },
			node2: { status: 'unknown', lastUpdate: null },
			node3: { status: 'unknown', lastUpdate: null }
		};

		// Custom Notification System
		function showNotification(message, type = 'info', duration = 5000) {
			const container = document.getElementById('notification-container');
			const notification = document.createElement('div');

			const icons = {
				success: '‚úÖ',
				error: '‚ùå',
				warning: '‚ö†Ô∏è',
				info: '‚ÑπÔ∏è',
				loading: 'üîÑ'
			};

			const colors = {
				success: 'bg-green-500 border-green-600',
				error: 'bg-red-500 border-red-600',
				warning: 'bg-yellow-500 border-yellow-600',
				info: 'bg-blue-500 border-blue-600',
				loading: 'bg-gray-500 border-gray-600'
			};

			notification.className = `${colors[type]} border-l-4 text-white p-4 rounded-r-lg shadow-lg transform transition-all duration-300 ease-in-out translate-x-full opacity-0`;
			notification.innerHTML = `
				<div class="flex items-center gap-3">
					<span class="text-xl">${icons[type]}</span>
					<div class="flex-1">
						<div class="font-semibold text-sm">${message}</div>
						<div class="text-xs opacity-75">${new Date().toLocaleTimeString()}</div>
					</div>
					<button class="text-white hover:text-gray-200 font-bold text-lg leading-none" onclick="this.parentElement.parentElement.remove()">√ó</button>
				</div>
			`;

			container.appendChild(notification);

			// Animate in
			setTimeout(() => {
				notification.classList.remove('translate-x-full', 'opacity-0');
			}, 100);

			// Auto remove
			setTimeout(() => {
				notification.classList.add('translate-x-full', 'opacity-0');
				setTimeout(() => notification.remove(), 300);
			}, duration);
		}

		// Update pump status display
		function updatePumpStatus(nodeId, status, timestamp = null) {
			const nodeNumber = nodeId.replace('node', '');
			const statusElement = document.getElementById(`kontrol-status-${nodeNumber}`);
			const lastUpdateElement = document.getElementById(`last-update-${nodeNumber}`);
			const indicatorElement = document.getElementById(`pump-indicator-${nodeNumber}`);
			const openBtn = document.getElementById(`btn-open-${nodeNumber}`);
			const closeBtn = document.getElementById(`btn-close-${nodeNumber}`);

			// Update status tracking
			pumpStatus[nodeId].status = status;
			pumpStatus[nodeId].lastUpdate = timestamp || new Date();

			// Update status text and styling
			if (status === 'open') {
				statusElement.innerHTML = 'üü¢ Terbuka';
				statusElement.className = 'font-bold text-green-700 text-sm px-3 py-1 bg-green-100 rounded-full border border-green-300';
				indicatorElement.innerHTML = `
					<div class="w-4 h-4 bg-green-500 rounded-full"></div>
					<div class="absolute -top-1 -right-1 w-6 h-6 bg-green-400 rounded-full opacity-50 animate-ping"></div>
				`;
			} else if (status === 'closed') {
				statusElement.innerHTML = 'üî¥ Tertutup';
				statusElement.className = 'font-bold text-red-700 text-sm px-3 py-1 bg-red-100 rounded-full border border-red-300';
				indicatorElement.innerHTML = `
					<div class="w-4 h-4 bg-red-500 rounded-full"></div>
					<div class="absolute -top-1 -right-1 w-6 h-6 bg-red-400 rounded-full opacity-50 animate-ping"></div>
				`;
			} else if (status === 'connecting') {
				statusElement.innerHTML = 'üü° Menghubungi...';
				statusElement.className = 'font-bold text-yellow-700 text-sm px-3 py-1 bg-yellow-100 rounded-full border border-yellow-300';
				indicatorElement.innerHTML = `
					<div class="w-4 h-4 bg-yellow-500 rounded-full animate-pulse"></div>
					<div class="absolute -top-1 -right-1 w-6 h-6 bg-yellow-400 rounded-full opacity-50 animate-ping"></div>
				`;
				// Disable buttons while connecting
				openBtn.disabled = true;
				closeBtn.disabled = true;
			} else {
				statusElement.innerHTML = '‚ö™ Tidak Diketahui';
				statusElement.className = 'font-bold text-gray-700 text-sm px-3 py-1 bg-gray-100 rounded-full border border-gray-300';
				indicatorElement.innerHTML = `
					<div class="w-4 h-4 bg-gray-400 rounded-full animate-pulse"></div>
					<div class="absolute -top-1 -right-1 w-6 h-6 bg-gray-300 rounded-full opacity-30 animate-ping"></div>
				`;
			}

			// Re-enable buttons if not connecting
			if (status !== 'connecting') {
				openBtn.disabled = false;
				closeBtn.disabled = false;
			}

			// Update last update time
			if (timestamp) {
				lastUpdateElement.textContent = timestamp.toLocaleTimeString();
			} else {
				lastUpdateElement.textContent = new Date().toLocaleTimeString();
			}
		}

		// Function to show console updates (since visual indicator was removed)
		function logUpdateStatus(message) {
			console.log(`[Real-time Update] ${message}`);
		}

		socket.on('connect', () => {
			console.log('‚úÖ Terhubung ke server via Socket.io');
			console.log('‚úÖ Real-time updates enabled');
			logUpdateStatus('Connected - Real-time Active');
			showNotification('Terhubung ke server', 'success', 3000);

			// Request current pump status
			socket.emit('pump:status:request');
		});

		socket.on('disconnect', () => {
			console.log('‚ùå Disconnected from server');
			logUpdateStatus('Disconnected');
			showNotification('Koneksi terputus dari server', 'warning', 5000);

			// Set all pumps to unknown status
			['node1', 'node2', 'node3'].forEach(nodeId => {
				updatePumpStatus(nodeId, 'unknown');
			});
		});

		// --- Real-time Chart Updates via Socket.io ---
		socket.on('data:update', (data) => {
			console.log('üåä Received unified data update:', data);
			logUpdateStatus('Unified Chart Data Received');

			// Update Flowrate Chart
			if (data.flowrate && data.flowrate.labels && data.flowrate.datasets) {
				updateChart('flowrate', data.flowrate);
			} else {
				console.error('‚ùå Invalid flowrate data in unified update:', data.flowrate);
			}

			// Update RSSI Chart
			if (data.rssi && data.rssi.labels && data.rssi.datasets) {
				updateChart('rssi', data.rssi);
			} else {
				console.error('‚ùå Invalid RSSI data in unified update:', data.rssi);
			}

			// Update Statistics Cards
			if (data.statistics) {
				updateStatisticsCards(data.statistics);
			}
		});

		// Function to update charts with new data
		function updateChart(canvasId, data) {
			// Always destroy existing chart and create a new one for reliable updates
			if (canvasId === 'flowrate') {
				if (flowrateChart) {
					flowrateChart.destroy();
					flowrateChart = null;
				}
				createFlowrateChart(data);
			} else if (canvasId === 'rssi') {
				if (rssiChart) {
					rssiChart.destroy();
					rssiChart = null;
				}
				createRssiChart(data);
			}

			// Cache the latest data
			if (canvasId === 'flowrate') {
				window.latestFlowrateData = data;
			} else {
				window.latestRssiData = data;
			}
			console.log(`üíæ ${canvasId} data cached.`);
		}

		socket.on('data:statistics:update', (data) => {
			console.log('üìà Received statistics update:', data);
			logUpdateStatus('Statistics Updated');
			updateStatisticsCards(data);
		});

		// Function to update statistics cards
		function updateStatisticsCards(data) {
			// Update Masjid 1
			if (data.node1) {
				const masjid1Value = document.getElementById('masjid1-value');
				const masjid1Growth = document.getElementById('masjid1-growth');
				if (masjid1Value) masjid1Value.textContent = `${data.node1.value.toLocaleString()} Liter`;
				if (masjid1Growth) masjid1Growth.textContent = `${data.node1.growth} dari periode sebelumnya`;
			}

			// Update Masjid 2
			if (data.node2) {
				const masjid2Value = document.getElementById('masjid2-value');
				const masjid2Growth = document.getElementById('masjid2-growth');
				if (masjid2Value) masjid2Value.textContent = `${data.node2.value.toLocaleString()} Liter`;
				if (masjid2Growth) masjid2Growth.textContent = `${data.node2.growth} dari periode sebelumnya`;
			}

			// Update Masjid 3
			if (data.node3) {
				const masjid3Value = document.getElementById('masjid3-value');
				const masjid3Growth = document.getElementById('masjid3-growth');
				if (masjid3Value) masjid3Value.textContent = `${data.node3.value.toLocaleString()} Liter`;
				if (masjid3Growth) masjid3Growth.textContent = `${data.node3.growth} dari periode sebelumnya`;
			}
		}

		function controlPipe(nodeId, action) {
			const nodeNumber = nodeId.replace('node', '');
			const masjidName = `Masjid ${nodeNumber}`;

			console.log(`Mengirim perintah: ${action} ke ${nodeId}`);

			// Show loading state
			updatePumpStatus(nodeId, 'connecting');
			showNotification(`Mengirim perintah ${action.toLowerCase()} ke ${masjidName}...`, 'loading', 3000);

			socket.emit('pipe:control', { nodeId, action });
		}

		socket.on('pipe:control:feedback', (data) => {
			const { nodeId, action, status, message } = data;
			const nodeNumber = nodeId ? nodeId.replace('node', '') : '';
			const masjidName = nodeNumber ? `Masjid ${nodeNumber}` : 'Pompa';

			if (status === 'success') {
				// Update status based on action
				const newStatus = action === 'OPEN' ? 'open' : 'closed';
				updatePumpStatus(nodeId, newStatus);
				showNotification(`${masjidName} berhasil ${action === 'OPEN' ? 'dibuka' : 'ditutup'}!`, 'success');
			} else {
				// Reset to unknown status on error
				updatePumpStatus(nodeId, 'unknown');
				showNotification(`Gagal mengontrol ${masjidName}: ${message}`, 'error');
			}
		});

		// Listen for real-time pump status updates from Blynk polling
		socket.on('pump:status:update', (data) => {
			const { timestamp, statuses } = data;

			// Update status for each pump
			Object.entries(statuses).forEach(([nodeId, status]) => {
				updatePumpStatus(nodeId, status, new Date(timestamp));
			});

			// Show notification for sync update (less intrusive, info type)
			const statusCount = Object.keys(statuses).length;
			showNotification(`Status ${statusCount} pompa disinkronisasi dengan Blynk`, 'info', 2000);
		});

		// Initialize first tab content
		switchTab('map');
	</script>
</body>

</html>